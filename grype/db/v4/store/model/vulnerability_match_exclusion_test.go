package model

import (
	"github.com/anchore/grype/grype/db/internal/sqlite"
	v4 "github.com/anchore/grype/grype/db/v4"
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestVulnerabilityMatchExclusionModel_Inflate(t *testing.T) {
	tests := []struct {
		name   string
		record *VulnerabilityMatchExclusionModel
		result *v4.VulnerabilityMatchExclusion
	}{
		{
			name: "Nil constraint",
			record: &VulnerabilityMatchExclusionModel{
				PK:            0,
				ID:            "CVE-12345",
				Constraints:   sqlite.ToNullString(nil),
				Justification: "Who really knows?",
			},
			result: &v4.VulnerabilityMatchExclusion{
				ID:            "CVE-12345",
				Constraints:   nil,
				Justification: "Who really knows?",
			},
		},
		{
			name: "Empty constraint array",
			record: &VulnerabilityMatchExclusionModel{
				PK:            0,
				ID:            "CVE-919",
				Constraints:   sqlite.ToNullString(`[]`),
				Justification: "Always ignore",
			},
			result: &v4.VulnerabilityMatchExclusion{
				ID:            "CVE-919",
				Constraints:   []v4.VulnerabilityMatchExclusionConstraint{},
				Justification: "Always ignore",
			},
		},
		{
			name: "Single constraint",
			record: &VulnerabilityMatchExclusionModel{
				PK:            0,
				ID:            "CVE-919",
				Constraints:   sqlite.ToNullString(`[{"vulnerability": {"namespace": "nvd:cpe"}, "package": {"language": "python"}}]`),
				Justification: "Python packages are not vulnerable",
			},
			result: &v4.VulnerabilityMatchExclusion{
				ID: "CVE-919",
				Constraints: []v4.VulnerabilityMatchExclusionConstraint{
					{
						Vulnerability: v4.VulnerabilityExclusionConstraint{
							Namespace: "nvd:cpe",
						},
						Package: v4.PackageExclusionConstraint{
							Language: "python",
						},
					},
				},
				Justification: "Python packages are not vulnerable",
			},
		},
	}

	for _, test := range tests {
		t.Run(test.name, func(t *testing.T) {
			result, err := test.record.Inflate()
			assert.NoError(t, err)
			assert.Equal(t, test.result, result)
		})
	}
}
